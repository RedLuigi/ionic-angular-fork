import * as tslib_1 from "tslib";
import { ChangeDetectionStrategy, Component, ContentChild, ElementRef, EmbeddedViewRef, IterableDiffer, IterableDiffers, NgZone, SimpleChanges, TrackByFunction } from '@angular/core';
import { ProxyCmp } from '../proxies-utils';
import { VirtualFooter } from './virtual-footer';
import { VirtualHeader } from './virtual-header';
import { VirtualItem } from './virtual-item';
let IonVirtualScroll = class IonVirtualScroll {
    constructor(z, iterableDiffers, elementRef) {
        this.z = z;
        this.iterableDiffers = iterableDiffers;
        this.refMap = new WeakMap();
        this.el = elementRef.nativeElement;
        this.el.nodeRender = this.nodeRender.bind(this);
    }
    ngOnChanges(changes) {
        if (this.trackBy && 'items' in changes) {
            // React on virtualScroll changes only once all inputs have been initialized
            const value = changes['items'].currentValue;
            if (this.differ === undefined && value != null) {
                try {
                    this.differ = this.iterableDiffers.find(value).create(this.trackBy);
                }
                catch (e) {
                    throw new Error(`Cannot find a differ supporting object '${value}'. VirtualScroll only supports binding to Iterables such as Arrays.`);
                }
            }
        }
    }
    ngDoCheck() {
        // and if there actually are changes
        const changes = this.differ !== undefined && this.items ? this.differ.diff(this.items) : null;
        if (changes === null) {
            return;
        }
        // TODO: optimize
        this.checkRange(0);
    }
    nodeRender(el, cell, index) {
        return this.z.run(() => {
            let node;
            if (!el) {
                node = this.itmTmp.viewContainer.createEmbeddedView(this.getComponent(cell.type), { $implicit: cell.value, index }, index);
                el = getElement(node);
                this.refMap.set(el, node);
            }
            else {
                node = this.refMap.get(el);
                const ctx = node.context;
                ctx.$implicit = cell.value;
                ctx.index = cell.index;
            }
            // run sync change detections
            node.detectChanges();
            return el;
        });
    }
    getComponent(type) {
        switch (type) {
            case 'item': return this.itmTmp.templateRef;
            case 'header': return this.hdrTmp.templateRef;
            case 'footer': return this.ftrTmp.templateRef;
        }
        throw new Error('template for virtual item was not provided');
    }
};
IonVirtualScroll.ctorParameters = () => [
    { type: NgZone },
    { type: IterableDiffers },
    { type: ElementRef }
];
tslib_1.__decorate([
    ContentChild(VirtualItem, { static: false })
], IonVirtualScroll.prototype, "itmTmp", void 0);
tslib_1.__decorate([
    ContentChild(VirtualHeader, { static: false })
], IonVirtualScroll.prototype, "hdrTmp", void 0);
tslib_1.__decorate([
    ContentChild(VirtualFooter, { static: false })
], IonVirtualScroll.prototype, "ftrTmp", void 0);
IonVirtualScroll = tslib_1.__decorate([
    ProxyCmp({
        inputs: ['approxItemHeight', 'approxHeaderHeight', 'approxFooterHeight', 'headerFn', 'footerFn', 'items', 'itemHeight', 'headerHeight', 'footerHeight'],
        methods: ['checkEnd', 'checkRange', 'positionForItem']
    }),
    Component({
        selector: 'ion-virtual-scroll',
        template: '<ng-content></ng-content>',
        changeDetection: ChangeDetectionStrategy.OnPush,
        inputs: [
            'approxItemHeight',
            'approxHeaderHeight',
            'approxFooterHeight',
            'headerFn',
            'footerFn',
            'items',
            'itemHeight',
            'headerHeight',
            'footerHeight',
            'trackBy'
        ]
    })
], IonVirtualScroll);
export { IonVirtualScroll };
const getElement = (view) => {
    const rootNodes = view.rootNodes;
    for (let i = 0; i < rootNodes.length; i++) {
        if (rootNodes[i].nodeType === 1) {
            return rootNodes[i];
        }
    }
    throw new Error('virtual element was not created');
};
const ɵ0 = getElement;
export { ɵ0 };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmlydHVhbC1zY3JvbGwuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AaW9uaWMvYW5ndWxhci8iLCJzb3VyY2VzIjpbImRpcmVjdGl2ZXMvdmlydHVhbC1zY3JvbGwvdmlydHVhbC1zY3JvbGwudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSx1QkFBdUIsRUFBRSxTQUFTLEVBQUUsWUFBWSxFQUFFLFVBQVUsRUFBRSxlQUFlLEVBQUUsY0FBYyxFQUFFLGVBQWUsRUFBRSxNQUFNLEVBQUUsYUFBYSxFQUFFLGVBQWUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUd2TCxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFFNUMsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQ2pELE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUNqRCxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFnSTdDLElBQWEsZ0JBQWdCLEdBQTdCLE1BQWEsZ0JBQWdCO0lBVTNCLFlBQ1UsQ0FBUyxFQUNULGVBQWdDLEVBQ3hDLFVBQXNCO1FBRmQsTUFBQyxHQUFELENBQUMsQ0FBUTtRQUNULG9CQUFlLEdBQWYsZUFBZSxDQUFpQjtRQVJsQyxXQUFNLEdBQUcsSUFBSSxPQUFPLEVBQWdELENBQUM7UUFXM0UsSUFBSSxDQUFDLEVBQUUsR0FBRyxVQUFVLENBQUMsYUFBNEMsQ0FBQztRQUNsRSxJQUFJLENBQUMsRUFBRSxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUNsRCxDQUFDO0lBRUQsV0FBVyxDQUFDLE9BQXNCO1FBQ2hDLElBQUksSUFBSSxDQUFDLE9BQU8sSUFBSSxPQUFPLElBQUksT0FBTyxFQUFFO1lBQ3RDLDRFQUE0RTtZQUM1RSxNQUFNLEtBQUssR0FBRyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUMsWUFB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b25lbnQsIENvbnRlbnRDaGlsZCwgRWxlbWVudFJlZiwgRW1iZWRkZWRWaWV3UmVmLCBJdGVyYWJsZURpZmZlciwgSXRlcmFibGVEaWZmZXJzLCBOZ1pvbmUsIFNpbXBsZUNoYW5nZXMsIFRyYWNrQnlGdW5jdGlvbiB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBDZWxsLCBDZWxsVHlwZSwgRm9vdGVySGVpZ2h0Rm4sIEhlYWRlckZuLCBIZWFkZXJIZWlnaHRGbiwgSXRlbUhlaWdodEZuIH0gZnJvbSAnQGlvbmljL2NvcmUnO1xyXG5cclxuaW1wb3J0IHsgUHJveHlDbXAgfSBmcm9tICcuLi9wcm94aWVzLXV0aWxzJztcclxuXHJcbmltcG9ydCB7IFZpcnR1YWxGb290ZXIgfSBmcm9tICcuL3ZpcnR1YWwtZm9vdGVyJztcclxuaW1wb3J0IHsgVmlydHVhbEhlYWRlciB9IGZyb20gJy4vdmlydHVhbC1oZWFkZXInO1xyXG5pbXBvcnQgeyBWaXJ0dWFsSXRlbSB9IGZyb20gJy4vdmlydHVhbC1pdGVtJztcclxuaW1wb3J0IHsgVmlydHVhbENvbnRleHQgfSBmcm9tICcuL3ZpcnR1YWwtdXRpbHMnO1xyXG5cclxuZXhwb3J0IGRlY2xhcmUgaW50ZXJmYWNlIElvblZpcnR1YWxTY3JvbGwge1xyXG4gIC8qKlxyXG4gICAqIEl0IGlzIGltcG9ydGFudCB0byBwcm92aWRlIHRoaXNcclxuICAgKiBpZiB2aXJ0dWFsIGl0ZW0gaGVpZ2h0IHdpbGwgYmUgc2lnbmlmaWNhbnRseSBsYXJnZXIgdGhhbiB0aGUgZGVmYXVsdFxyXG4gICAqIFRoZSBhcHByb3hpbWF0ZSBoZWlnaHQgb2YgZWFjaCB2aXJ0dWFsIGl0ZW0gdGVtcGxhdGUncyBjZWxsLlxyXG4gICAqIFRoaXMgZGltZW5zaW9uIGlzIHVzZWQgdG8gaGVscCBkZXRlcm1pbmUgaG93IG1hbnkgY2VsbHMgc2hvdWxkXHJcbiAgICogYmUgY3JlYXRlZCB3aGVuIGluaXRpYWxpemVkLCBhbmQgdG8gaGVscCBjYWxjdWxhdGUgdGhlIGhlaWdodCBvZlxyXG4gICAqIHRoZSBzY3JvbGxhYmxlIGFyZWEuIFRoaXMgaGVpZ2h0IHZhbHVlIGNhbiBvbmx5IHVzZSBgcHhgIHVuaXRzLlxyXG4gICAqIE5vdGUgdGhhdCB0aGUgYWN0dWFsIHJlbmRlcmVkIHNpemUgb2YgZWFjaCBjZWxsIGNvbWVzIGZyb20gdGhlXHJcbiAgICogYXBwJ3MgQ1NTLCB3aGVyZWFzIHRoaXMgYXBwcm94aW1hdGlvbiBpcyB1c2VkIHRvIGhlbHAgY2FsY3VsYXRlXHJcbiAgICogaW5pdGlhbCBkaW1lbnNpb25zIGJlZm9yZSB0aGUgaXRlbSBoYXMgYmVlbiByZW5kZXJlZC5cclxuICAgKi9cclxuICBhcHByb3hJdGVtSGVpZ2h0OiBudW1iZXI7XHJcblxyXG4gIC8qKlxyXG4gICAqIFRoZSBhcHByb3hpbWF0ZSBoZWlnaHQgb2YgZWFjaCBoZWFkZXIgdGVtcGxhdGUncyBjZWxsLlxyXG4gICAqIFRoaXMgZGltZW5zaW9uIGlzIHVzZWQgdG8gaGVscCBkZXRlcm1pbmUgaG93IG1hbnkgY2VsbHMgc2hvdWxkXHJcbiAgICogYmUgY3JlYXRlZCB3aGVuIGluaXRpYWxpemVkLCBhbmQgdG8gaGVscCBjYWxjdWxhdGUgdGhlIGhlaWdodCBvZlxyXG4gICAqIHRoZSBzY3JvbGxhYmxlIGFyZWEuIFRoaXMgaGVpZ2h0IHZhbHVlIGNhbiBvbmx5IHVzZSBgcHhgIHVuaXRzLlxyXG4gICAqIE5vdGUgdGhhdCB0aGUgYWN0dWFsIHJlbmRlcmVkIHNpemUgb2YgZWFjaCBjZWxsIGNvbWVzIGZyb20gdGhlXHJcbiAgICogYXBwJ3MgQ1NTLCB3aGVyZWFzIHRoaXMgYXBwcm94aW1hdGlvbiBpcyB1c2VkIHRvIGhlbHAgY2FsY3VsYXRlXHJcbiAgICogaW5pdGlhbCBkaW1lbnNpb25zIGJlZm9yZSB0aGUgaXRlbSBoYXMgYmVlbiByZW5kZXJlZC5cclxuICAgKi9cclxuICBhcHByb3hIZWFkZXJIZWlnaHQ6IG51bWJlcjtcclxuXHJcbiAgLyoqXHJcbiAgICogVGhlIGFwcHJveGltYXRlIHdpZHRoIG9mIGVhY2ggZm9vdGVyIHRlbXBsYXRlJ3MgY2VsbC5cclxuICAgKiBUaGlzIGRpbWVuc2lvbiBpcyB1c2VkIHRvIGhlbHAgZGV0ZXJtaW5lIGhvdyBtYW55IGNlbGxzIHNob3VsZFxyXG4gICAqIGJlIGNyZWF0ZWQgd2hlbiBpbml0aWFsaXplZCwgYW5kIHRvIGhlbHAgY2FsY3VsYXRlIHRoZSBoZWlnaHQgb2ZcclxuICAgKiB0aGUgc2Nyb2xsYWJsZSBhcmVhLiBUaGlzIGhlaWdodCB2YWx1ZSBjYW4gb25seSB1c2UgYHB4YCB1bml0cy5cclxuICAgKiBOb3RlIHRoYXQgdGhlIGFjdHVhbCByZW5kZXJlZCBzaXplIG9mIGVhY2ggY2VsbCBjb21lcyBmcm9tIHRoZVxyXG4gICAqIGFwcCdzIENTUywgd2hlcmVhcyB0aGlzIGFwcHJveGltYXRpb24gaXMgdXNlZCB0byBoZWxwIGNhbGN1bGF0ZVxyXG4gICAqIGluaXRpYWwgZGltZW5zaW9ucyBiZWZvcmUgdGhlIGl0ZW0gaGFzIGJlZW4gcmVuZGVyZWQuXHJcbiAgICovXHJcbiAgYXBwcm94Rm9vdGVySGVpZ2h0OiBudW1iZXI7XHJcblxyXG4gIC8qKlxyXG4gICAqIFNlY3Rpb24gaGVhZGVycyBhbmQgdGhlIGRhdGEgdXNlZCB3aXRoaW4gaXRzIGdpdmVuXHJcbiAgICogdGVtcGxhdGUgY2FuIGJlIGR5bmFtaWNhbGx5IGNyZWF0ZWQgYnkgcGFzc2luZyBhIGZ1bmN0aW9uIHRvIGBoZWFkZXJGbmAuXHJcbiAgICogRm9yIGV4YW1wbGUsIGEgbGFyZ2UgbGlzdCBvZiBjb250YWN0cyB1c3VhbGx5IGhhcyBkaXZpZGVycyBiZXR3ZWVuIGVhY2hcclxuICAgKiBsZXR0ZXIgaW4gdGhlIGFscGhhYmV0LiBBcHAncyBjYW4gcHJvdmlkZSB0aGVpciBvd24gY3VzdG9tIGBoZWFkZXJGbmBcclxuICAgKiB3aGljaCBpcyBjYWxsZWQgd2l0aCBlYWNoIHJlY29yZCB3aXRoaW4gdGhlIGRhdGFzZXQuIFRoZSBsb2dpYyB3aXRoaW5cclxuICAgKiB0aGUgaGVhZGVyIGZ1bmN0aW9uIGNhbiBkZWNpZGUgaWYgdGhlIGhlYWRlciB0ZW1wbGF0ZSBzaG91bGQgYmUgdXNlZCxcclxuICAgKiBhbmQgd2hhdCBkYXRhIHRvIGdpdmUgdG8gdGhlIGhlYWRlciB0ZW1wbGF0ZS4gVGhlIGZ1bmN0aW9uIG11c3QgcmV0dXJuXHJcbiAgICogYG51bGxgIGlmIGEgaGVhZGVyIGNlbGwgc2hvdWxkbid0IGJlIGNyZWF0ZWQuXHJcbiAgICovXHJcbiAgaGVhZGVyRm4/OiBIZWFkZXJGbjtcclxuXHJcbiAgLyoqXHJcbiAgICogU2VjdGlvbiBmb290ZXJzIGFuZCB0aGUgZGF0YSB1c2VkIHdpdGhpbiBpdHMgZ2l2ZW5cclxuICAgKiB0ZW1wbGF0ZSBjYW4gYmUgZHluYW1pY2FsbHkgY3JlYXRlZCBieSBwYXNzaW5nIGEgZnVuY3Rpb24gdG8gYGZvb3RlckZuYC5cclxuICAgKiBUaGUgbG9naWMgd2l0aGluIHRoZSBmb290ZXIgZnVuY3Rpb24gY2FuIGRlY2lkZSBpZiB0aGUgZm9vdGVyIHRlbXBsYXRlXHJcbiAgICogc2hvdWxkIGJlIHVzZWQsIGFuZCB3aGF0IGRhdGEgdG8gZ2l2ZSB0byB0aGUgZm9vdGVyIHRlbXBsYXRlLiBUaGUgZnVuY3Rpb25cclxuICAgKiBtdXN0IHJldHVybiBgbnVsbGAgaWYgYSBmb290ZXIgY2VsbCBzaG91bGRuJ3QgYmUgY3JlYXRlZC5cclxuICAgKi9cclxuICBmb290ZXJGbj86IEhlYWRlckZuO1xyXG5cclxuICAvKipcclxuICAgKiBUaGUgZGF0YSB0aGF0IGJ1aWxkcyB0aGUgdGVtcGxhdGVzIHdpdGhpbiB0aGUgdmlydHVhbCBzY3JvbGwuXHJcbiAgICogSXQncyBpbXBvcnRhbnQgdG8gbm90ZSB0aGF0IHdoZW4gdGhpcyBkYXRhIGhhcyBjaGFuZ2VkLCB0aGVuIHRoZVxyXG4gICAqIGVudGlyZSB2aXJ0dWFsIHNjcm9sbCBpcyByZXNldCwgd2hpY2ggaXMgYW4gZXhwZW5zaXZlIG9wZXJhdGlvbiBhbmRcclxuICAgKiBzaG91bGQgYmUgYXZvaWRlZCBpZiBwb3NzaWJsZS5cclxuICAgKi9cclxuICBpdGVtcz86IGFueVtdO1xyXG5cclxuICAvKipcclxuICAgKiBBbiBvcHRpb25hbCBmdW5jdGlvbiB0aGF0IG1hcHMgZWFjaCBpdGVtIHdpdGhpbiB0aGVpciBoZWlnaHQuXHJcbiAgICogV2hlbiB0aGlzIGZ1bmN0aW9uIGlzIHByb3ZpZGVkLCBoZWF2eSBvcHRpbWl6YXRpb25zIGFuZCBmYXN0IHBhdGggY2FuIGJlIHRha2VkIGJ5XHJcbiAgICogYGlvbi12aXJ0dWFsLXNjcm9sbGAgbGVhZGluZyB0byBtYXNzaXZlIHBlcmZvcm1hbmNlIGltcHJvdmVtZW50cy5cclxuICAgKlxyXG4gICAqIFRoaXMgZnVuY3Rpb24gYWxsb3dzIHRvIHNraXAgYWxsIERPTSByZWFkcywgd2hpY2ggY2FuIGJlIERvaW5nIHNvIGxlYWRzXHJcbiAgICogdG8gbWFzc2l2ZSBwZXJmb3JtYW5jZVxyXG4gICAqL1xyXG4gIGl0ZW1IZWlnaHQ/OiBJdGVtSGVpZ2h0Rm47XHJcblxyXG4gIC8qKlxyXG4gICAqIEFuIG9wdGlvbmFsIGZ1bmN0aW9uIHRoYXQgbWFwcyBlYWNoIGl0ZW0gaGVhZGVyIHdpdGhpbiB0aGVpciBoZWlnaHQuXHJcbiAgICovXHJcbiAgaGVhZGVySGVpZ2h0PzogSGVhZGVySGVpZ2h0Rm47XHJcblxyXG4gIC8qKlxyXG4gICAqIEFuIG9wdGlvbmFsIGZ1bmN0aW9uIHRoYXQgbWFwcyBlYWNoIGl0ZW0gZm9vdGVyIHdpdGhpbiB0aGVpciBoZWlnaHQuXHJcbiAgICovXHJcbiAgZm9vdGVySGVpZ2h0PzogRm9vdGVySGVpZ2h0Rm47XHJcblxyXG4gIC8qKlxyXG4gICAqIFNhbWUgYXMgYG5nRm9yVHJhY2tCeWAgd2hpY2ggY2FuIGJlIHVzZWQgb24gYG5nRm9yYC5cclxuICAgKi9cclxuICB0cmFja0J5OiBUcmFja0J5RnVuY3Rpb248YW55PjtcclxuXHJcbiAgLyoqXHJcbiAgICogVGhpcyBtZXRob2QgbWFya3MgdGhlIHRhaWwgdGhlIGl0ZW1zIGFycmF5IGFzIGRpcnR5LCBzbyB0aGV5IGNhbiBiZSByZS1yZW5kZXJlZC4gIEl0J3MgZXF1aXZhbGVudCB0byBjYWxsaW5nOiAgYGBganMgICAgKiB2aXJ0dWFsU2Nyb2xsLmNoZWNrUmFuZ2UobGFzdEl0ZW1MZW4sIGl0ZW1zLmxlbmd0aCAtIGxhc3RJdGVtTGVuKTsgICAgKiBgYGBcclxuICAgKi9cclxuICAnY2hlY2tFbmQnOiAoKSA9PiB2b2lkO1xyXG4gIC8qKlxyXG4gICAqIFRoaXMgbWV0aG9kIG1hcmtzIGEgc3Vic2V0IG9mIGl0ZW1zIGFzIGRpcnR5LCBzbyB0aGV5IGNhbiBiZSByZS1yZW5kZXJlZC4gSXRlbXMgc2hvdWxkIGJlIG1hcmtlZCBhcyBkaXJ0eSBhbnkgdGltZSB0aGUgY29udGVudCBvciB0aGVpciBzdHlsZSBjaGFuZ2VzLiAgVGhlIHN1YnNldCBvZiBpdGVtcyB0byBiZSB1cGRhdGVkIGNhbiBhcmUgc3BlY2lmaW5nIGJ5IGFuIG9mZnNldCBhbmQgYSBsZW5ndGguXHJcbiAgICovXHJcbiAgJ2NoZWNrUmFuZ2UnOiAob2Zmc2V0OiBudW1iZXIsIGxlbj86IG51bWJlcikgPT4gdm9pZDtcclxuICAvKipcclxuICAgKiBSZXR1cm5zIHRoZSBwb3NpdGlvbiBvZiB0aGUgdmlydHVhbCBpdGVtIGF0IHRoZSBnaXZlbiBpbmRleC5cclxuICAgKi9cclxuICAncG9zaXRpb25Gb3JJdGVtJzogKGluZGV4OiBudW1iZXIpID0+IFByb21pc2U8bnVtYmVyPjtcclxufVxyXG5cclxuQFByb3h5Q21wKHtcclxuICBpbnB1dHM6IFsnYXBwcm94SXRlbUhlaWdodCcsICdhcHByb3hIZWFkZXJIZWlnaHQnLCAnYXBwcm94Rm9vdGVySGVpZ2h0JywgJ2hlYWRlckZuJywgJ2Zvb3RlckZuJywgJ2l0ZW1zJywgJ2l0ZW1IZWlnaHQnLCAnaGVhZGVySGVpZ2h0JywgJ2Zvb3RlckhlaWdodCddLFxyXG4gIG1ldGhvZHM6IFsnY2hlY2tFbmQnLCAnY2hlY2tSYW5nZScsICdwb3NpdGlvbkZvckl0ZW0nXVxyXG59KVxyXG5AQ29tcG9uZW50KHtcclxuICBzZWxlY3RvcjogJ2lvbi12aXJ0dWFsLXNjcm9sbCcsXHJcbiAgdGVtcGxhdGU6ICc8bmctY29udGVudD48L25nLWNvbnRlbnQ+JyxcclxuICBjaGFuZ2VEZXRlY3Rpb246IENoYW5nZURldGVjdGlvblN0cmF0ZWd5Lk9uUHVzaCxcclxuICBpbnB1dHM6IFtcclxuICAgICdhcHByb3hJdGVtSGVpZ2h0JyxcclxuICAgICdhcHByb3hIZWFkZXJIZWlnaHQnLFxyXG4gICAgJ2FwcHJveEZvb3RlckhlaWdodCcsXHJcbiAgICAnaGVhZGVyRm4nLFxyXG4gICAgJ2Zvb3RlckZuJyxcclxuICAgICdpdGVtcycsXHJcbiAgICAnaXRlbUhlaWdodCcsXHJcbiAgICAnaGVhZGVySGVpZ2h0JyxcclxuICAgICdmb290ZXJIZWlnaHQnLFxyXG4gICAgJ3RyYWNrQnknXHJcbiAgXVxyXG59KVxyXG5leHBvcnQgY2xhc3MgSW9uVmlydHVhbFNjcm9sbCB7XHJcblxyXG4gIHByaXZhdGUgZGlmZmVyPzogSXRlcmFibGVEaWZmZXI8YW55PjtcclxuICBwcml2YXRlIGVsOiBIVE1MSW9uVmlydHVhbFNjcm9sbEVsZW1lbnQ7XHJcbiAgcHJpdmF0ZSByZWZNYXAgPSBuZXcgV2Vha01hcDxIVE1MRWxlbWVudCwgRW1iZWRkZWRWaWV3UmVmPFZpcnR1YWxDb250ZXh0Pj4oKTtcclxuXHJcbiAgQENvbnRlbnRDaGlsZChWaXJ0dWFsSXRlbSwgeyBzdGF0aWM6IGZhbHNlIH0pIGl0bVRtcCE6IFZpcnR1YWxJdGVtO1xyXG4gIEBDb250ZW50Q2hpbGQoVmlydHVhbEhlYWRlciwgeyBzdGF0aWM6IGZhbHNlIH0pIGhkclRtcCE6IFZpcnR1YWxIZWFkZXI7XHJcbiAgQENvbnRlbnRDaGlsZChWaXJ0dWFsRm9vdGVyLCB7IHN0YXRpYzogZmFsc2UgfSkgZnRyVG1wITogVmlydHVhbEZvb3RlcjtcclxuXHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICBwcml2YXRlIHo6IE5nWm9uZSxcclxuICAgIHByaXZhdGUgaXRlcmFibGVEaWZmZXJzOiBJdGVyYWJsZURpZmZlcnMsXHJcbiAgICBlbGVtZW50UmVmOiBFbGVtZW50UmVmLFxyXG4gICkge1xyXG4gICAgdGhpcy5lbCA9IGVsZW1lbnRSZWYubmF0aXZlRWxlbWVudCBhcyBIVE1MSW9uVmlydHVhbFNjcm9sbEVsZW1lbnQ7XHJcbiAgICB0aGlzLmVsLm5vZGVSZW5kZXIgPSB0aGlzLm5vZGVSZW5kZXIuYmluZCh0aGlzKTtcclxuICB9XHJcblxyXG4gIG5nT25DaGFuZ2VzKGNoYW5nZXM6IFNpbXBsZUNoYW5nZXMpOiB2b2lkIHtcclxuICAgIGlmICh0aGlzLnRyYWNrQnkgJiYgJ2l0ZW1zJyBpbiBjaGFuZ2VzKSB7XHJcbiAgICAgIC8vIFJlYWN0IG9uIHZpcnR1YWxTY3JvbGwgY2hhbmdlcyBvbmx5IG9uY2UgYWxsIGlucHV0cyBoYXZlIGJlZW4gaW5pdGlhbGl6ZWRcclxuICAgICAgY29uc3QgdmFsdWUgPSBjaGFuZ2VzWydpdGVtcyddLmN1cnJlbnRWYWx1ZTtcclxuICAgICAgaWYgKHRoaXMuZGlmZmVyID09PSB1bmRlZmluZWQgJiYgdmFsdWUgIT0gbnVsbCkge1xyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICB0aGlzLmRpZmZlciA9IHRoaXMuaXRlcmFibGVEaWZmZXJzLmZpbmQodmFsdWUpLmNyZWF0ZSh0aGlzLnRyYWNrQnkpO1xyXG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcclxuICAgICAgICAgICAgYENhbm5vdCBmaW5kIGEgZGlmZmVyIHN1cHBvcnRpbmcgb2JqZWN0ICcke3ZhbHVlfScuIFZpcnR1YWxTY3JvbGwgb25seSBzdXBwb3J0cyBiaW5kaW5nIHRvIEl0ZXJhYmxlcyBzdWNoIGFzIEFycmF5cy5gKTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcblxyXG4gIG5nRG9DaGVjaygpIHtcclxuICAgIC8vIGFuZCBpZiB0aGVyZSBhY3R1YWxseSBhcmUgY2hhbmdlc1xyXG4gICAgY29uc3QgY2hhbmdlcyA9IHRoaXMuZGlmZmVyICE9PSB1bmRlZmluZWQgJiYgdGhpcy5pdGVtcyA/IHRoaXMuZGlmZmVyLmRpZmYodGhpcy5pdGVtcykgOiBudWxsO1xyXG4gICAgaWYgKGNoYW5nZXMgPT09IG51bGwpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgLy8gVE9ETzogb3B0aW1pemVcclxuICAgIHRoaXMuY2hlY2tSYW5nZSgwKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgbm9kZVJlbmRlcihlbDogSFRNTEVsZW1lbnQgfCBudWxsLCBjZWxsOiBDZWxsLCBpbmRleDogbnVtYmVyKTogSFRNTEVsZW1lbnQge1xyXG4gICAgcmV0dXJuIHRoaXMuei5ydW4oKCkgPT4ge1xyXG4gICAgICBsZXQgbm9kZTogRW1iZWRkZWRWaWV3UmVmPFZpcnR1YWxDb250ZXh0PjtcclxuICAgICAgaWYgKCFlbCkge1xyXG4gICAgICAgIG5vZGUgPSB0aGlzLml0bVRtcC52aWV3Q29udGFpbmVyLmNyZWF0ZUVtYmVkZGVkVmlldyhcclxuICAgICAgICAgIHRoaXMuZ2V0Q29tcG9uZW50KGNlbGwudHlwZSksXHJcbiAgICAgICAgICB7ICRpbXBsaWNpdDogY2VsbC52YWx1ZSwgaW5kZXggfSxcclxuICAgICAgICAgIGluZGV4XHJcbiAgICAgICAgKTtcclxuICAgICAgICBlbCA9IGdldEVsZW1lbnQobm9kZSk7XHJcbiAgICAgICAgdGhpcy5yZWZNYXAuc2V0KGVsLCBub2RlKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBub2RlID0gdGhpcy5yZWZNYXAuZ2V0KGVsKSE7XHJcbiAgICAgICAgY29uc3QgY3R4ID0gbm9kZS5jb250ZXh0O1xyXG4gICAgICAgIGN0eC4kaW1wbGljaXQgPSBjZWxsLnZhbHVlO1xyXG4gICAgICAgIGN0eC5pbmRleCA9IGNlbGwuaW5kZXg7XHJcbiAgICAgIH1cclxuICAgICAgLy8gcnVuIHN5bmMgY2hhbmdlIGRldGVjdGlvbnNcclxuICAgICAgbm9kZS5kZXRlY3RDaGFuZ2VzKCk7XHJcbiAgICAgIHJldHVybiBlbDtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBnZXRDb21wb25lbnQodHlwZTogQ2VsbFR5cGUpIHtcclxuICAgIHN3aXRjaCAodHlwZSkge1xyXG4gICAgICBjYXNlICdpdGVtJzogcmV0dXJuIHRoaXMuaXRtVG1wLnRlbXBsYXRlUmVmO1xyXG4gICAgICBjYXNlICdoZWFkZXInOiByZXR1cm4gdGhpcy5oZHJUbXAudGVtcGxhdGVSZWY7XHJcbiAgICAgIGNhc2UgJ2Zvb3Rlcic6IHJldHVybiB0aGlzLmZ0clRtcC50ZW1wbGF0ZVJlZjtcclxuICAgIH1cclxuICAgIHRocm93IG5ldyBFcnJvcigndGVtcGxhdGUgZm9yIHZpcnR1YWwgaXRlbSB3YXMgbm90IHByb3ZpZGVkJyk7XHJcbiAgfVxyXG59XHJcblxyXG5jb25zdCBnZXRFbGVtZW50ID0gKHZpZXc6IEVtYmVkZGVkVmlld1JlZjxWaXJ0dWFsQ29udGV4dD4pOiBIVE1MRWxlbWVudCA9PiB7XHJcbiAgY29uc3Qgcm9vdE5vZGVzID0gdmlldy5yb290Tm9kZXM7XHJcbiAgZm9yIChsZXQgaSA9IDA7IGkgPCByb290Tm9kZXMubGVuZ3RoOyBpKyspIHtcclxuICAgIGlmIChyb290Tm9kZXNbaV0ubm9kZVR5cGUgPT09IDEpIHtcclxuICAgICAgcmV0dXJuIHJvb3ROb2Rlc1tpXTtcclxuICAgIH1cclxuICB9XHJcbiAgdGhyb3cgbmV3IEVycm9yKCd2aXJ0dWFsIGVsZW1lbnQgd2FzIG5vdCBjcmVhdGVkJyk7XHJcbn07XHJcbiJdfQ==